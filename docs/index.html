
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WFH Kanban Board (Synced)</title>
  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {{
      getFirestore, doc, getDoc, setDoc, onSnapshot
    }} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {{
      apiKey: "AIzaSyCxHyL3-ecLuVjGrM2HjEbfAV7Kgh-Ufs8",
      authDomain: "wfh-board.firebaseapp.com",
      projectId: "wfh-board",
      storageBucket: "wfh-board.appspot.com",
      messagingSenderId: "204510362340",
      appId: "1:204510362340:web:77f93cb517cbbee2f70af1"
    }};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const employees = {employees_json};
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const columns = ["In Office", "Working from Home", "On Annual Leave"];
    let state = {{}};

    const boardRef = doc(db, "board", "current");

    async function loadState() {{
      const docSnap = await getDoc(boardRef);
      if (docSnap.exists()) {{
        state = docSnap.data();
      }} else {{
        initializeState();
        await setDoc(boardRef, state);
      }}
      render();
    }}

    function initializeState() {{
      days.forEach((_, dayIdx) => {{
        state[dayIdx] = {{
          "In Office": employees.map(e => e.Name),
          "Working from Home": [],
          "On Annual Leave": []
        }};
      }});
    }}

    async function moveCard(day, column, name) {{
      state[day] = state[day] || {{}};
      columns.forEach(col => {{
        state[day][col] = (state[day][col] || []).filter(p => p !== name);
      }});

      if (column === "Working from Home") {{
        const wfhCount = (state[day]["Working from Home"] || []).length;
        const alreadyWFH = Object.entries(state).some(([d, cols]) =>
          parseInt(d) !== parseInt(day) && (cols["Working from Home"] || []).includes(name)
        );
        if (wfhCount >= 3 || alreadyWFH) {{
          alert("WFH limit exceeded or already booked this week.");
          render();
          return;
        }}
      }}

      state[day][column] = state[day][column] || [];
      state[day][column].push(name);
      await setDoc(boardRef, state);
    }}

    function createCard(person, dayIdx, column) {{
      const card = document.createElement("div");
      card.className = "card";
      card.draggable = true;
      card.dataset.name = person.Name;
      card.innerHTML = `<img src='${{person['Photo URL']}}' alt='${{person.Name}}'><span>${{person.Name}}</span>`;
      card.addEventListener("dragstart", (e) => {{
        e.dataTransfer.setData("text", person.Name);
      }});
      return card;
    }}

    function render() {{
      days.forEach((day, dayIdx) => {{
        const container = document.getElementById("day-" + dayIdx);
        if (!container) return;
        container.innerHTML = "";
        const cols = document.createElement("div");
        cols.className = "columns";

        columns.forEach(col => {{
          const colDiv = document.createElement("div");
          colDiv.className = "column";
          colDiv.dataset.day = dayIdx;
          colDiv.dataset.column = col;

          colDiv.addEventListener("dragover", e => e.preventDefault());
          colDiv.addEventListener("drop", e => {{
            const name = e.dataTransfer.getData("text");
            moveCard(dayIdx, col, name);
          }});

          const title = document.createElement("h2");
          title.textContent = col;
          colDiv.appendChild(title);

          const people = (state[dayIdx]?.[col] || []);
          people.forEach(name => {{
            const person = employees.find(p => p.Name === name);
            if (person) colDiv.appendChild(createCard(person, dayIdx, col));
          }});

          cols.appendChild(colDiv);
        }});
        container.appendChild(cols);
      }});
    }}

    function setupTabs() {{
      const tabBar = document.getElementById("tabs");
      const container = document.getElementById("dayContainers");
      days.forEach((day, idx) => {{
        const btn = document.createElement("button");
        btn.textContent = day;
        btn.className = "tab-button";
        btn.onclick = () => {{
          document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
          document.querySelectorAll(".day-container").forEach(c => c.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById("day-" + idx).classList.add("active");
        }};
        tabBar.appendChild(btn);

        const dayDiv = document.createElement("div");
        dayDiv.className = "day-container";
        dayDiv.id = "day-" + idx;
        container.appendChild(dayDiv);
      }});
      tabBar.firstChild.click();
    }}

    setupTabs();
    loadState();

    onSnapshot(boardRef, (docSnap) => {{
      if (docSnap.exists()) {{
        state = docSnap.data();
        render();
      }}
    }});
  </script>
  <style>
    body {{ font-family: sans-serif; padding: 2rem; }}
    h1 {{ margin-bottom: 1rem; }}
    .tabs {{ display: flex; gap: 1rem; margin-bottom: 1rem; }}
    .tab-button {{
      padding: 0.5rem 1rem;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
    }}
    .tab-button.active {{
      background: #ddd;
      font-weight: bold;
    }}
    .day-container {{ display: none; }}
    .day-container.active {{ display: block; }}
    .columns {{ display: flex; gap: 1rem; }}
    .column {{
      flex: 1;
      padding: 1rem;
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 8px;
      min-height: 300px;
    }}
    .column h2 {{ margin-top: 0; }}
    .card {{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: grab;
    }}
    .card img {{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }}
  </style>
</head>
<body>
  <h1>WFH Booking Board (Cloud Synced)</h1>
  <div class="tabs" id="tabs"></div>
  <div id="dayContainers"></div>
</body>
</html>
